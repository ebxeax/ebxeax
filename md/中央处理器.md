# 中央处理器
控制器：负责协调并控制计算机各部件执行程序的指令序列：取指令、分析指令、执行指令  
运算器：对数据加工
- 指令控制
- 操作控制
- 数据加工
- 时间控制
- 中断处理

### 基本结构
运算器和控制器两大部分组成  
运算器：
- 算术逻辑单元（ALU）
- 暂存寄存器
- 累加寄存器（ACC）
- 通用寄存器组（AX/BX/CX/DX/SP）
- 程序状态字寄存器（PSW：OF/SF/ZF/CF）
- 移位器
- 计数器

控制器（CU）：
- 程序计数器（PC）
- 指令寄存器（IR）
- 指令译码器
- 存储器地址寄存器
- 存储器数据寄存器
- 时序系统
- 微操作信号发生器

## 指令执行过程
### 指令周期
CPU从主存取出并执行一条指令的时间，指令周期通常使用若干机器周期表示，每个机器周期可等长或不等，一个机器周期包含若干时钟周期（节拍），每个机器周期内的时钟周期数可以不等
- 无条件转移指令：执行阶段不需要访存，只包含取指阶段（取指和分析）和执行阶段
- 间接寻址指令：为了取操作数，需要先访1次，取出有效地址，然后访存，取出操作数，所有需要包含间址周期，介于取指和执行之间
- CPU采用中断方式实现主机和I/O设备的信息交换，CPU在每条指令结束前，都要发送中断查询信号，若有中断请求，CPU进入中断响应阶段（中断周期）

|||||
|-|-|-|-|
|取指周期|间址周期|执行周期|中断周期|

只有访存的目的不同，取指周期是为了取指令，间址周期是为了取有效地址，执行周期是为了取操作数，中断周期是为了保存程序断点  
CPU内设置了4个标志触发器FE/IND/EX/INT

|FE|IND|EX|INT|
|-|-|-|-|
|Fetch|Index|Execute|Interrupt|
|取值|间址|执行|中断|

### 指令周期的数据流
#### 取指周期
根据PC中的内容从主存取出指令代码放入IR  
- PC $\to$ IR $\to$ AddrBus $\to$ Mem
- CU $\to$ DataBus $\to$ MDR $\to$ Mem
- Mem $\to$ DataBus $\to$ MDR $\to$ IR（存放指令）
- CU $\stackrel{SignalControl::FE}{\longrightarrow}$ [(PC) + 1 $\to$ PC]

#### 间址周期
取操作数有效地址，间址为例：指令中的地址码送到MAR并送至地址总线，CU向存储器发送读命令，以获取有效地址并存在MDR  
- Addr(IR) / MDR $\to$ MAR $\to$ AddrBus $\to$ Mem
- CU $\stackrel{SignalI/O::READ}{\longrightarrow}$ ControlBus $\to$ Mem（存放有效地址）
- Mem $\to$ DataBus $\to$ MDR

#### 执行周期
取操作数，根据IR的指令字的操作码通过ALU操作产生执行结果
- 无统一的数据流向

#### 中断周期
处理中断请求，假设程序断点存入堆栈，用SP指示栈顶地址，入栈操作是先修改栈顶指针，后存入数据
- CU $\stackrel{SignalStack::SP}{\longrightarrow}$ [(SP) - 1 $\to$ SP] $\to$ MAR $\to$ AddrBus $\to$ Mem
- CU $\stackrel{SignalI/O::WRITE}{\longrightarrow}$ ControlBus $\to$ Mem
- PC $\to$ MDR $\to$ DataBus $\to$ Mem（程序断点存入主存）
- CU $\to$ PC（中断服务程序的入口地址送至PC）

### 指令执行方案
- 单指令周期
- 多指令周期
- 流水线方案

## 数据通路
### 功能
数据通路：数据在功能部件之间传输的路径  
由控制部件控制，控制部件根据每条指令功能的不同生成对数据通路的控制信号   
数据通路功能：实现CPU内部的运算器与寄存器以及寄存器之间的数据交换

### 基本结构
- CPU内部单总线模式  
所有寄存器的输入输出端都连接在一条公共通路上，结构简单但数据传输存在较多的冲突现象，性能较低。连接各部件的总线只有一条时，称为单总线结构，CPU中有两条或更多的总线时，构成双总线结构或多总线结构
- CPU内部多总线模式  
所有寄存器的输入输出端都连接在多条公共通路上，相比之下单总线在一个时钟内只允许传一个数据，因此指令执行效率很低，因此在多总线方式，同时在多总线上传输不同的数据，提高效率
- 专用数据通路方式  
根据指令执行过程中的数据和地址的流动方向安排连接线路，避免使用共享的总线，性能较高，但硬件量大

#### 寄存器之间的数据传输
通过内部总线完成  
寄存器AX的输入输出由AXout和AXin控制  

- (PC) $\to$ MAR，PCout和MARin有效


#### 主存与CPU之间的数据传输
主存与CPU之间的数据传输需要借助CPU内部总线完成  
主存内读取

- (PC) $\to$ MAR，PCout和MARin有效  
- 1 $\to$ R，CU发出读命令  
- MEM(MAR) $\to$ MDR，MDRin有效  
- (MDR) $\to$ IR，MDRout和IRin有效  

#### 执行算术或逻辑算术
由于ALU没有内部存储功能，执行加法操作，相加的两个数必须在ALU的两个输入输出端同时有效

- (MDR) $\to$ MAR，MDRout和MARin有效  
- 1 $\to$ R，CU读命令
- MEM(MAR) $\to$ 操作数从主存送至MDR
- (MDR) $\to$ Y，MDRout和Yin有效
- (ACC) + (Y) $\to$ Z ACCout和ALUin有效
- (Z) $\to$ ACC，Zout和ACCin有效

## 控制器功能与原理
### 结构和功能
- 运算器部件通过数据总线与内存储器、输入设备和输出设备传送数据
- 输入设备和输出设备通过接口电路与总线相连接
- 内存储器、输入设备通过接口电路与总线相连接
- 内存储器、输入设备和输出设备从地址总线接收地址信息，从控制总线得到控制信号，通过数据总线与其他部件传输数据
- 控制器部件从数据总线接受指令信息，从运算器部件接收指令转移地址，送出指令地址到地址总线，还要向系统中的部件通过运算所需的控制信号


控制器功能：
- 从主存取指令，并指出下一条指令在主存中的位置
- 对指令进行译码或测试，产生相应的操作控制信号，以便启动规定的动作
- 指挥并控制CPU、主存、输入输出设备之间的数据流动方向


根据控制器产生微操作控制信号的方式不同，控制器可分为
- 硬布线控制器
- 微程序控制器

两类控制器的PC和IR是相同的，但确定和表示指令执行步骤的办法以及给出控制部件各部件运算所需控制信号的方案不同

### 硬布线控制器
- 根据指令的要求、当前的时序及外部和内部的状态，按时间的顺序发送一系列微操作控制信号
- 由复杂的组合逻辑门电路和一些触发器构成

#### 硬布线控制单元
指令的操作码是决定控制单元发出不同操作命令（控制信号）的关键  
CU的输入信号来源：
- 经指令译码器译码产生的信息指令
- 时序系统产生的机器周期信号和节拍信号
- 来自执行单元的反馈信号（标志）
- 系统总线（控制总线）控制信号（中断请求、DMA请求）

#### 硬布线控制器的时序系统及微操作
- 时钟周期  
用时钟信号控制节拍发生器，可以产生节拍，每个节拍的宽度对应一个时钟周期，每个节拍内机器可以完成一个或几个需要同时执行的操作
- 机器周期  
是所有指令执行过程的一个基准时间，访问一次存储器的时间是固定的，因此通常以存取周期作为基准时间，即内存中读取一个指令字的最短时间作为机器周期，在存储字长等于指令字长前提下，取指周期视为机器周期
- 指令周期
- 微操作命令分析  
控制单元具有发出各种操作命令（控制信号）序列的功能，这些命令与指令有关

执行过程，一条指令分为3个工作周期：取指周期、间址周期、执行周期  

取指周期  
- (PC) $\to$ MAR  
- 1 $\to$ R  
- M(MAR) $\to$ MDR
- (MDR) $\to$ IR
- OP(IR) $\to$ CU
- (PC) + 1  $\to$ PC

间址周期
- Addr(IR) $\to$ MAR
- 1  $\to$ R
- M(MAR)  $\to$ MDR

执行周期  
- 非访存指令  
- 访存指令

#### CPU控制方式
- 同步控制方式  
具有统一的时钟，所有控制信号均来自统一的时钟信号
- 异步控制方式
不存在基准时标信号，各部件按自身固有的速度工作，以应答方式联络
- 联合控制方式
大部分采用同步控制，小部分采用异步控制

### 微程序控制器
采用存储逻辑实现,把微操作信号代码化,使每条机器指令转化为一段微程序并存入一个专门的存储器（控制存储器），微操作控制信号由微指令产生

#### 基本概念
- 微操作和微命令  
一条机器指令可以分解为一系列微操作序列，微操作是计算机中最基本、不可再分解的操作；微程序控制的计算机中，将控制部件向执行部件发出的各种控制命令称为微命令，是构成控制系列的最小单位  
微命令有相容性和互斥性

- 微指令和微周期
微指令是若干微命令的集合，存放微指令的控制存储器的单元地址称为微地址  
一条微地址包括：  
（1）操作控制字段（微操作码）：用于产生某一步操作所需的各种操作控制信号  
（2）顺序控制字段（微地址码）：用于控制产生下一条要执行的微指令地址  
微周期是执行一条微指令所需的时间，通常为一个时钟周期  

- 主存储器和控制存储器  
主存储器M，用于存放程序和数据，在CPU外部，用RAM实现  
控制存储器CM，用于存放微程序，在CPU内部，用ROM实现

- 程序和微程序
程序是指令的有序集合，用于完成某些特定的功能  
微程序是微指令的有序集合，一条指令的给你由一段微程序实现  
微程序和程序是两个不同的概念，微程序由微指令组成，描述机器指令，微程序实质是机器指令的实时解释器，由计算机设计者实现编制并存放于控制存储器CM中，无需知道，而程序最终由机器指令组成，由软件设计人员事先编制并存放于主存储器或辅助存储器

|||||
|-|-|-|-|
|MAR|存放主存的读写地址|CMAR|存放控制存储器的读写微指令地址|
|IR|存放从主存中读出的指令|CMDR/$\mu$IR|存放控制存储器中读出的微指令|

#### 组成&过程
- 控制存储器：存放各指令对应的微程序
- 微指令寄存器：用于存放从CM中取出的微指令，位数同微指令字长相等
- 微地址形成部件：产生初始微地址和后继微地址，以保证微指令的连续执行
- 微地址寄存器：接收微地址形成部件送来的微地址，为在CM中读取微指令作准备  

在微程序控制器的控制下计算器执行机器指令的过程：  
- 执行取微指令：自动将取指微程序的入口地址送入CMAR，从CM中读取相应的微指令送入CMDR（取指微程序的入口地址一般为CM的0号单元，当取指微程序执行完成，从主存取出的机器指令就已经存入指令寄存器中）
- 由机器指令的操作码字段通过微地址形成部件产生该机器指令对应的微程序入口地址，并送入CMAR
- 从CM中逐条读取对应的微指令并执行
- 执行完对应于一条机器指令的一个微程序后，又回到取指微程序的入口地址，继续第一步

微程序和机器指令：  
一条机器指令对应一个微程序，由于机器指令的取指令操作都是相同的，因此可将取指令操作的微命令统一编制为一个微程序，这个微程序只负责将指令从主存单元取出送入指令寄存器，也可编制对应的间址周期和中断周期的微程序  
控制存储器CM中的微程序个数 = 机器指令数+取指+间址+中断

#### 编码方式

#### 地址形成方式


#### 格式



||微程序控制器|硬布线控制器|
|-|-|-|
|工作原理|微操作控制信号以微程序的形式存放在控制存储器中，执行指令时读出即可|微操作控制信号由组合逻辑电路根据当前的指令码、状态和时序，即时产生|
|执行速度|慢|快|
|规整性|较规整|烦琐、不规整|
|应用场合|CISC CPU|RISC CPU|
|易扩充性|容易|困难|